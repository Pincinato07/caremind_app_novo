name: Deploy Release Tunnel

on:
  push:
    tags:
      - 'v*' # Dispara apenas quando você criar uma tag ex: v1.0.0

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      # 1. Baixa o código
      - uses: actions/checkout@v4

      # 2. Configura Java (cache automático do Gradle já incluído)
      - uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      # 3. Configura Flutter (cache automático já incluído)
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.1'
          channel: 'stable'
          cache: true

      # 4. Cria key.properties para assinatura
      - name: Create key.properties
        run: |
          echo "storeFile=${{ github.workspace }}/android/app/upload-keystore.jks" > android/key.properties
          echo "keyAlias=${{ secrets.KEY_ALIAS }}" >> android/key.properties
          echo "keyPassword=${{ secrets.KEY_PASSWORD }}" >> android/key.properties
          echo "storePassword=${{ secrets.STORE_PASSWORD }}" >> android/key.properties

      # 5. Decodifica keystore
      - name: Decode Keystore
        run: echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -di > android/app/upload-keystore.jks

      # 6. Instala dependências
      - name: Get Dependencies
        run: flutter pub get

      # 7. Build APK Release (split per ABI - mais rápido)
      - name: Build APK Release
        run: flutter build apk --release --split-per-abi
        env:
          GRADLE_OPTS: "-Dorg.gradle.jvmargs=-Xmx4g -Dorg.gradle.parallel=true -Dorg.gradle.caching=true"

      # --- AQUI COMEÇA A MÁGICA DOS REPOS ---

      # 8. Salva no Repo PRIVADO (Histórico Completo)
      - name: Release no Privado
        uses: softprops/action-gh-release@v2
        with:
          files: |
            build/app/outputs/flutter-apk/app-*-release.apk
          name: Release ${{ github.ref_name }}
          body: "Release gerada automaticamente."

      # 9. Deploy no Repo PÚBLICO (Apenas Última Versão)
      - name: Deploy para Público (Última Versão)
        env:
          GH_TOKEN: ${{ secrets.PUBLIC_REPO_TOKEN }}
          PUBLIC_REPO: "Pincinato07/caremind-downloads"
        run: |
          if gh release view latest --repo $PUBLIC_REPO >/dev/null 2>&1; then
            gh release delete latest --repo $PUBLIC_REPO --yes
          fi
          
          if gh api --silent "repos/$PUBLIC_REPO/git/refs/tags/latest" >/dev/null 2>&1; then
            gh api -X DELETE "repos/$PUBLIC_REPO/git/refs/tags/latest"
          fi
          
          gh release create latest \
            build/app/outputs/flutter-apk/app-*-release.apk \
            --repo $PUBLIC_REPO \
            --title "Download Oficial CareMind" \
            --notes "Versão mais recente: ${{ github.ref_name }}" \
            --target main